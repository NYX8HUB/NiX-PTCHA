(function() {
    // URL da API (Será substituída pelo Python automaticamente)
    const API_BASE = "__API_URL__";

    // 1. Injeta CSS
    const style = document.createElement('style');
    style.innerHTML = `
        .my-captcha { 
            background: #f9f9f9; border: 1px solid #d3d3d3; border-radius: 4px; 
            width: 300px; padding: 10px; display: flex; align-items: center; 
            font-family: sans-serif; user-select: none; position: relative;
        }
        .my-captcha-check {
            width: 24px; height: 24px; border: 2px solid #aaa; border-radius: 2px;
            cursor: pointer; background: #fff; margin-right: 10px;
        }
        .my-captcha-check.checked { background: #00b894; border-color: #00b894; }
        
        /* Modal do Desafio */
        .captcha-modal {
            position: absolute; top: 110%; left: 0; background: white; 
            border: 1px solid #ccc; padding: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            z-index: 1000; display: none; width: 280px; border-radius: 5px;
        }
        .captcha-modal input { width: 100%; padding: 8px; margin: 10px 0; box-sizing: border-box;}
        .captcha-modal button { background: #0984e3; color: white; border: none; padding: 5px 15px; cursor: pointer; border-radius: 3px;}
    `;
    document.head.appendChild(style);

    // 2. Coleta de Dados de "Humanidade"
    let mouseTrace = [];
    document.addEventListener('mousemove', (e) => {
        if(mouseTrace.length < 50) { // Grava apenas os primeiros 50 movimentos
            mouseTrace.push([e.clientX, e.clientY]);
        }
    });

    function initCaptcha() {
        const containers = document.querySelectorAll('.g-recaptcha');
        
        containers.forEach(box => {
            box.innerHTML = `
                <div class="my-captcha">
                    <div class="my-captcha-check" id="c-box"></div>
                    <span>Não sou um robô</span>
                    
                    <div class="captcha-modal" id="c-modal">
                        <p id="c-question">Carregando...</p>
                        <input type="text" id="c-input" placeholder="Sua resposta">
                        <button id="c-btn">Verificar</button>
                        <p id="c-msg" style="font-size:12px; color:red; margin-top:5px;"></p>
                    </div>
                </div>
                <input type="hidden" name="g-recaptcha-response" id="c-token">
            `;

            const checkbox = box.querySelector('#c-box');
            const modal = box.querySelector('#c-modal');
            const questionTxt = box.querySelector('#c-question');
            const inputBtn = box.querySelector('#c-btn');
            const inputField = box.querySelector('#c-input');
            const msg = box.querySelector('#c-msg');
            const hiddenInput = box.querySelector('#c-token');
            
            let currentToken = "";

            // Ao clicar no checkbox
            checkbox.addEventListener('click', async () => {
                if (checkbox.classList.contains('checked')) return;

                // Abre o modal e pede desafio ao servidor
                modal.style.display = 'block';
                msg.innerText = "Verificando ambiente...";
                
                try {
                    const req = await fetch(`${API_BASE}/get-challenge`);
                    const data = await req.json();
                    
                    questionTxt.innerText = data.question;
                    currentToken = data.token;
                    msg.innerText = "";
                    inputField.focus();
                } catch(e) {
                    msg.innerText = "Erro ao conectar.";
                }
            });

            // Ao clicar em Verificar
            inputBtn.addEventListener('click', async (e) => {
                e.preventDefault();
                msg.innerText = "Validando...";
                
                const payload = {
                    token: currentToken,
                    answer: inputField.value,
                    mouse_trace: mouseTrace // Envia rastro do mouse para analise
                };

                const req = await fetch(`${API_BASE}/verify`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });
                
                const resp = await req.json();
                
                if (resp.success) {
                    modal.style.display = 'none';
                    checkbox.classList.add('checked');
                    // Preenche o input oculto para o formulário oficial
                    hiddenInput.value = "VALIDADO_PELO_SERVIDOR_" + currentToken.substring(0,10);
                } else {
                    msg.innerText = resp.error || "Tente novamente.";
                    inputField.value = "";
                    // Opcional: Pedir novo desafio aqui
                }
            });
        });
    }

    document.addEventListener("DOMContentLoaded", initCaptcha);
})();
